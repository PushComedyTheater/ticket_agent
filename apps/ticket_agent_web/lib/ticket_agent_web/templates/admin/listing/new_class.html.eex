<%= render "partial/listing_template.html", assigns %>
<%= render "partial/ticket_template.html", assigns %>

<%= form_for @conn, admin_event_path(@conn, :create), [as: :listing], fn f -> %>
  <%= hidden_input f, :class_id, value: @class.id %>
  <div class="box box-primary">
    <div class="box-header with-border">
      <h3 class="box-title">New Class From <%= @class.title %></h3>
    </div>
    <!-- /.box-body -->
    <div class="box-body">
      <div id="listing_title_group" class="row form-group">
        <div class="col-sm-2">
          <%= label f, :title, class: "control-label" %>
        </div>
        <div class="col-sm-10">
          <%= text_input f, :title, class: "form-control", placeholder: "Make it short and catchy", value: @class.title %>
          <span id="listing_title_error" style="display: none;" class="help-block">This field is required</span>
        </div>
      </div>
      <div id="listing_description_group" class="row form-group">
        <div class="col-sm-2"><%= label f, :description, class: "control-label" %></div>
        <div class="col-sm-10">
        <%= textarea(f, :description, class: "ckeditor", cols: 80, rows: 10, value: @class.description) %>
        <span id="listing_description_error" style="display: none;" class="help-block">This field is required</span>
        </div>
      </div>    
    </div>
  </div>        
  <div class="box box-primary">
    <div class="box-header with-border">
      <h3 class="box-title">When is your event?</h3>
      <span class="pull-right">
        <button id="add_another_time_btn" type="button" class="btn btn-block btn-success btn-flat"><i class="fa fa-fw fa-plus"></i> Add Another Time</button>
      </span>
    </div>
    <!-- /.box-body -->
    <div class="box-body" id="listing_times" data-counter="0">
    </div>
    <hr>
  </div>
  <div class="box box-primary">
    <div class="box-header with-border">
      <h3 class="box-title">Image</h3>
    </div>
    <!-- /.box-body -->
    <div class="box-body">
    <img src="<%= @class.image_url %>" width="100" align="left" style="padding: 10px;">
    All classes inherit their image from the base class. This cannot be changed without changing for all.
    </div>
    <hr>
  </div>     
  <button id="create_class" type="button" class="btn btn-block btn-success btn-flat">Create New Class Listing </button>
<% end %>

<script type="text/javascript">
  window.current_date_time = new Date().toJSON().slice(0, 10) + " 00:00";

  window.setup_date_pickers = function(counter) {
    $('.listing_time').datetimepicker({
      format: 'yyyy-mm-dd hh:ii',
      showMeridian: true,
      autoclose: true,
      startDate: window.current_date_time,
      todayBtn: true
    })
    .on('changeDate', function(ev){
      var target = $(ev.target);
      if (target.data("before")) {
        var before = target.data("before");
        $("#" + before).datetimepicker('setStartDate', target.val());
        $("#" + before).datetimepicker('setInitialDate', target.val());
      }
    });
  }

  window.setup_delete_button = function(counter) {
    $("#delete_" + counter).on("click", function(e) {
      e.preventDefault();
      if (confirm("Are you sure you want to remove this time and all associated tickets?")) {
        $("#row_" + counter).remove();
        $("#tickets_" + counter).remove();
      }
    });
  };

  window.setup_add_ticket_button = function(counter) {
    $("#add_ticket_" + counter).on("click", function(e) {
      e.preventDefault();
      var detail = window.ticket_template({ticket_count: counter});
      $("#tickets_" + counter).append(detail);
    });
  };  

  window.add_listing_template = function() {
    var times_counter = $(".listing_template").length;
    var html = window.listing_template({times_counter: times_counter});
    $("#listing_times").append(html);
    window.setup_delete_button(times_counter);
    window.setup_add_ticket_button(times_counter);
    window.setup_date_pickers(times_counter);
  }

  window.create_class = function(e) {
    if ($("#listing_title").val().length == 0) {
      $("#listing_title_error").show();
      $("#listing_title_group").addClass("has-error");
      $("#listing_title").focus();
    } else {
      $("#listing_title_error").hide();
      $("#listing_title_group").removeClass("has-error");  
    }

    var ck_instance = CKEDITOR.instances["listing_description"].editable();
    if (ck_instance) {
      var listing_description = ck_instance.getText();
      if (listing_description.length == 0) {
        $("#listing_description_error").show();
        $("#listing_description_group").addClass("has-error");
      } else {
        $("#listing_description_error").hide();
        $("#listing_description_group").removeClass("has-error");        
      }
    }

    var template_count = $(".listing_template").length;
    console.log("template_count = " + template_count);
    for(var i = 0; i < template_count; i++) {
      var start_time = $("#listing_start_time_" + i).val();
      var end_time   = $("#listing_end_time_" + i).val();

      if (start_time.length == 0) {
        $("#listing_start_time_group_" + i).addClass("has-error");
      } else {
        $("#listing_start_time_group_" + i).removeClass("has-error");
      }

      if (end_time.length == 0) {
        $("#listing_end_time_group_" + i).addClass("has-error");
      } else {
        $("#listing_end_time_group_" + i).removeClass("has-error");
      }      
      
      
      console.log(start_time < end_time);
    }
    e.preventDefault();
  }

  $(function () {
    window.listing_template = Handlebars.compile($("#listing-template").html());
    window.ticket_template  = Handlebars.compile($("#ticket-template").html());

    window.add_listing_template();

    $("#add_another_time_btn").on("click", function(e) {
      e.preventDefault();
      window.add_listing_template();
    });

    $("#create_class").on("click", function(e) {
      window.create_class(e);
    });
  });
</script>