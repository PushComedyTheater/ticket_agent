<%= render TicketAgentWeb.LayoutView, "ticket_info.html", assigns %>
<section class="g-bg-white">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <%= render "ticket_quantity.html", assigns %>
      </div>
      <div class="col-md-6">
        <%= if Coherence.logged_in?(@conn) do %>
          <button id="continue" class="btn btn-block u-btn-primary g-font-size-18 g-py-15 mb-4" type="button">
            <i class="fa fa-check-circle g-mr-5"></i>
            <span id="logged_in_text">Purchase 1 Ticket As <%= Coherence.current_user_name(@conn) %></span>
          </button>
        <% else %>
          <%= render "guest_information.html", assigns %>
        <% end %>
      </div>
    </div>
  </div>

</section>

<script type="text/javascript">
  window.ticket_count = 1;
  window.ticket_cost = <%= @conn.assigns.ticket_price / 100 %>;
  window.show_id = "<%= @listing.slug %>";
  window.buyer_name = "<%= Coherence.current_user_name(@conn, :name) %>";
  window.buyer_email = "<%= Coherence.current_user_name(@conn, :email) %>";
  
  window.redirect_it = function() {
    var details = {
      show_id: window.show_id,
      buyer_name: window.buyer_name,
      buyer_email: window.buyer_email,
      ticket_count: window.ticket_count,
      guest_checkout: <%= !Coherence.logged_in?(@conn) %>,
      tickets: []
    }
    console.log(details);
    var encodedData = window.btoa(JSON.stringify(details));
    Cookies.set("ticket_data", encodedData);
    var redirect_url = "/ticket_information/new?show_id=" + show_id;
    window.location.href = redirect_url;
  }

  window.set_button = function() {
    var resultVal = parseInt($("#ticket_count").val());
    if (window.buyer_name.length == 0) {
      window.buyer_name = "Guest";
    }
    $("#guest_text").text("Reserve " + window.ticket_count + " Ticket(s) As " + window.buyer_name);
    $("#logged_in_text").text("Reserve " + window.ticket_count + " Ticket(s) As <%= Coherence.current_user_name(@conn) %>");
  }

  $(document).on('ready', function () {
    $("#ticket_count").on("change", function() {
      window.ticket_count = parseInt($("#ticket_count").val());
      window.set_button();
      var total = (window.ticket_count * window.ticket_cost).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
      $("#invoice_cost").html("$" + total);
    })

    $("#guest_name").on("change", function() {
      window.buyer_name = $("#guest_name").val();
      window.set_button();
    });

    $("#guest_email").on("change", function() {
      window.buyer_email = $("#guest_email").val();
      window.set_button();
    });    

    $("#continue").on("click", function(e) {
      window.ticket_count = parseInt($("#ticket_count").val());
      e.preventDefault();
      window.redirect_it();
    })

    $("#continue_as_guest").on("click", function(e) {
      window.ticket_count = parseInt($("#ticket_count").val());
      window.buyer_name = $("#guest_name").val();
      window.buyer_email = $("#guest_email").val();
      var email_valid = $("#guest_email")[0].checkValidity();

      if (window.buyer_name.length <= 0) {
        $("#name_group").addClass("u-has-error-v1");
        $("#name_required").show();
        return false;
      } else {
        $("#name_group").removeClass("u-has-error-v1");
        $("#name_required").hide();          
      }

      if ((window.buyer_email.length <= 0) || (!email_valid)) {
        if (!email_valid) {
          $("#email_required").html("Email must be a valid email address.");
        } else {
          $("#email_required").html("This is a required field.");
        }
        $("#email_group").addClass("u-has-error-v1");
        $("#email_required").show();
        return false;          
      } else {
        $("#email_group").removeClass("u-has-error-v1");
        $("#email_required").hide();
      }
      window.redirect_it();
    })    
  });
</script>
